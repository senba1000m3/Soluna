# BERT4Rec è¨“ç·´æ¶æ§‹ç¸½çµ

## ğŸ“Œ é …ç›®æ¦‚è¿°

é€™æ˜¯ä¸€å€‹å®Œæ•´çš„ BERT4Rec å‹•ç•«æ¨è–¦æ¨¡å‹è¨“ç·´æ¶æ§‹ï¼ŒåŒ…å«æ•¸æ“šæº–å‚™ã€æ¨¡å‹è¨“ç·´ã€æº–ç¢ºç‡è¨ˆç®—å’Œè¦–è¦ºåŒ–åŠŸèƒ½ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. å®Œæ•´çš„è¨“ç·´æµç¨‹

```
æ•¸æ“šæº–å‚™ â†’ ç”¨æˆ¶è¼‰å…¥ â†’ æ¨¡å‹è¨“ç·´ â†’ çµæœè¦–è¦ºåŒ–
    â†“           â†“           â†“           â†“
 3000éƒ¨å‹•ç•«   ç”¨æˆ¶æ¸…å–®    200 epochs   Loss/Accåœ–è¡¨
```

### 2. æ ¸å¿ƒæ¨¡å¡Š

| æ–‡ä»¶ | åŠŸèƒ½ | èªªæ˜ |
|------|------|------|
| `config.py` | é…ç½®ç®¡ç† | æ‰€æœ‰è¨“ç·´åƒæ•¸çš„é›†ä¸­ç®¡ç† |
| `train_model.py` | è¨“ç·´ä¸»è…³æœ¬ | åŒ…å« BERT4Rec æ¨¡å‹ã€è¨“ç·´å™¨ã€æº–ç¢ºç‡è¨ˆç®— |
| `visualize.py` | è¦–è¦ºåŒ–å·¥å…· | ç”Ÿæˆ Loss å’Œ Accuracy åœ–è¡¨ |
| `prepare_dataset.py` | æ•¸æ“šæº–å‚™ | æŠ“å– 3000 éƒ¨ç†±é–€å‹•ç•« |
| `load_users.py` | ç”¨æˆ¶è¼‰å…¥ | å¾æ–‡ä»¶è®€å–ç”¨æˆ¶ä¸¦æŠ“å–è§€çœ‹è¨˜éŒ„ |
| `anilist_client.py` | API å®¢æˆ¶ç«¯ | AniList API å°è£ |

### 3. æ‰¹æ¬¡åŸ·è¡Œè…³æœ¬

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `setup.bat` | ç’°å¢ƒåˆå§‹åŒ–ï¼ˆå®‰è£ä¾è³´ã€å‰µå»ºç›®éŒ„ï¼‰ |
| `1_prepare_anime.bat` | æ­¥é©Ÿ 1ï¼šæº–å‚™å‹•ç•«æ•¸æ“š |
| `2_load_users.bat` | æ­¥é©Ÿ 2ï¼šè¼‰å…¥ç”¨æˆ¶æ•¸æ“š |
| `3_train_model.bat` | æ­¥é©Ÿ 3ï¼šè¨“ç·´æ¨¡å‹ï¼ˆCPUï¼‰ |
| `3_train_model_gpu.bat` | æ­¥é©Ÿ 3ï¼šè¨“ç·´æ¨¡å‹ï¼ˆGPUï¼‰ |
| `run_all.bat` | ä¸€éµå®Œæˆæ‰€æœ‰æ­¥é©Ÿ |

### 4. è¨“ç·´æŒ‡æ¨™

æ¨¡å‹æœƒè‡ªå‹•è¨ˆç®—å’Œè¨˜éŒ„ï¼š

- âœ… **Training Loss** - è¨“ç·´æå¤±
- âœ… **Validation Loss** - é©—è­‰æå¤±
- âœ… **Top-1 Accuracy** - ç¬¬ä¸€åé æ¸¬æº–ç¢ºç‡
- âœ… **Top-5 Accuracy** - å‰äº”åé æ¸¬æº–ç¢ºç‡
- âœ… **Top-10 Accuracy** - å‰ååé æ¸¬æº–ç¢ºç‡
- âœ… **Top-20 Accuracy** - å‰äºŒååé æ¸¬æº–ç¢ºç‡

### 5. è¦–è¦ºåŒ–è¼¸å‡º

è¨“ç·´å®Œæˆå¾Œè‡ªå‹•ç”Ÿæˆï¼š

- ğŸ“Š `loss_curve.png` - Loss æ›²ç·šåœ–
- ğŸ“Š `accuracy_curve.png` - Top-K Accuracy æ›²ç·šåœ–
- ğŸ“Š `combined_metrics.png` - ç¶œåˆæŒ‡æ¨™åœ–ï¼ˆ4 åˆ 1ï¼‰
- ğŸ“Š `learning_curve.png` - å¹³æ»‘å­¸ç¿’æ›²ç·š
- ğŸ“Š `training_metrics.json` - å®Œæ•´è¨“ç·´æŒ‡æ¨™ï¼ˆJSON æ ¼å¼ï¼‰

## ğŸ¯ è¨“ç·´é…ç½®

### é è¨­åƒæ•¸

```python
# è¨“ç·´åƒæ•¸
epochs: 200              # è¨“ç·´è¼ªæ•¸
batch_size: 64          # æ‰¹æ¬¡å¤§å°
learning_rate: 1e-3     # å­¸ç¿’ç‡
val_ratio: 0.1          # é©—è­‰é›†æ¯”ä¾‹ (10%)

# æ¨¡å‹åƒæ•¸
hidden_size: 256        # éš±è—å±¤ç¶­åº¦
num_layers: 2          # Transformer å±¤æ•¸
num_heads: 4           # æ³¨æ„åŠ›é ­æ•¸
max_seq_len: 200       # æœ€å¤§åºåˆ—é•·åº¦
dropout: 0.1           # Dropout æ¯”ç‡

# æ•¸æ“šåƒæ•¸
num_anime: 3000        # å‹•ç•«æ•¸é‡
min_user_anime: 20     # ç”¨æˆ¶æœ€å°‘å‹•ç•«æ•¸
mask_prob: 0.15        # BERT é®ç½©æ©Ÿç‡
```

## ğŸ“ ç›®éŒ„çµæ§‹

```
bert_training/
â”œâ”€â”€ config.py                    # é…ç½®æ–‡ä»¶
â”œâ”€â”€ train_model.py               # ä¸»è¨“ç·´è…³æœ¬
â”œâ”€â”€ visualize.py                 # è¦–è¦ºåŒ–å·¥å…·
â”œâ”€â”€ prepare_dataset.py           # æº–å‚™å‹•ç•«æ•¸æ“š
â”œâ”€â”€ load_users.py                # è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
â”œâ”€â”€ anilist_client.py            # AniList API å®¢æˆ¶ç«¯
â”œâ”€â”€ datas_user.txt              # ç”¨æˆ¶åå–®
â”œâ”€â”€ requirements.txt            # ä¾è³´å¥—ä»¶
â”œâ”€â”€ README.md                   # å®Œæ•´èªªæ˜æ–‡æª”
â”œâ”€â”€ QUICK_START.md              # å¿«é€Ÿé–‹å§‹æŒ‡å—
â”œâ”€â”€ SUMMARY.md                  # æœ¬æ–‡ä»¶
â”‚
â”œâ”€â”€ setup.bat                   # ç’°å¢ƒè¨­ç½®è…³æœ¬
â”œâ”€â”€ run_all.bat                 # ä¸€éµåŸ·è¡Œæ‰€æœ‰æ­¥é©Ÿ
â”œâ”€â”€ 1_prepare_anime.bat         # æ­¥é©Ÿ 1
â”œâ”€â”€ 2_load_users.bat            # æ­¥é©Ÿ 2
â”œâ”€â”€ 3_train_model.bat           # æ­¥é©Ÿ 3 (CPU)
â”œâ”€â”€ 3_train_model_gpu.bat       # æ­¥é©Ÿ 3 (GPU)
â”‚
â”œâ”€â”€ data/                       # è³‡æ–™ç›®éŒ„
â”‚   â””â”€â”€ bert.db                # è¨“ç·´è³‡æ–™åº«
â”‚
â””â”€â”€ output/                     # è¼¸å‡ºç›®éŒ„
    â”œâ”€â”€ models/                 # è¨“ç·´æ¨¡å‹
    â”‚   â”œâ”€â”€ best_model.pth     # æœ€ä½³æ¨¡å‹
    â”‚   â”œâ”€â”€ final_model.pth    # æœ€çµ‚æ¨¡å‹
    â”‚   â”œâ”€â”€ item_mappings.pkl  # é …ç›®æ˜ å°„
    â”‚   â””â”€â”€ training_config.json # è¨“ç·´é…ç½®
    â”‚
    â”œâ”€â”€ plots/                  # è¨“ç·´åœ–è¡¨
    â”‚   â”œâ”€â”€ loss_curve.png
    â”‚   â”œâ”€â”€ accuracy_curve.png
    â”‚   â”œâ”€â”€ combined_metrics.png
    â”‚   â”œâ”€â”€ learning_curve.png
    â”‚   â””â”€â”€ training_metrics.json
    â”‚
    â”œâ”€â”€ logs/                   # æ—¥èªŒæ–‡ä»¶
    â””â”€â”€ checkpoints/            # è¨“ç·´æª¢æŸ¥é»
        â”œâ”€â”€ checkpoint_epoch_10.pth
        â”œâ”€â”€ checkpoint_epoch_20.pth
        â””â”€â”€ ...
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1: ä¸€éµåŸ·è¡Œï¼ˆæœ€ç°¡å–®ï¼‰

```bash
# 1. è¨­ç½®ç’°å¢ƒ
setup.bat

# 2. åŸ·è¡Œå®Œæ•´æµç¨‹
run_all.bat
```

### æ–¹å¼ 2: åˆ†æ­¥åŸ·è¡Œï¼ˆæ›´å¤šæ§åˆ¶ï¼‰

```bash
# 0. è¨­ç½®ç’°å¢ƒ
setup.bat

# 1. æº–å‚™å‹•ç•«æ•¸æ“š
1_prepare_anime.bat

# 2. è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
2_load_users.bat

# 3. è¨“ç·´æ¨¡å‹
3_train_model.bat          # CPU ç‰ˆæœ¬
# æˆ–
3_train_model_gpu.bat      # GPU ç‰ˆæœ¬
```

### æ–¹å¼ 3: å‘½ä»¤åˆ—ï¼ˆæœ€éˆæ´»ï¼‰

```bash
# å®‰è£ä¾è³´
pip install -r requirements.txt

# æº–å‚™æ•¸æ“š
python prepare_dataset.py --count 3000
python load_users.py --min-anime 20

# è¨“ç·´æ¨¡å‹
python train_model.py --epochs 200 --batch-size 64 --gpu
```

## ğŸ“Š è¨“ç·´è¼¸å‡ºèªªæ˜

### 1. æ¨¡å‹æ–‡ä»¶ (`output/models/`)

- **best_model.pth**: é©—è­‰ Loss æœ€ä½çš„æ¨¡å‹ï¼ˆæ¨è–¦ä½¿ç”¨ï¼‰
- **final_model.pth**: æœ€å¾Œä¸€å€‹ epoch çš„æ¨¡å‹
- **item_mappings.pkl**: å‹•ç•« ID åˆ°ç´¢å¼•çš„æ˜ å°„
- **training_config.json**: è¨“ç·´æ™‚ä½¿ç”¨çš„é…ç½®

### 2. è¦–è¦ºåŒ–åœ–è¡¨ (`output/plots/`)

- **combined_metrics.png**: æœ€é‡è¦ï¼åŒ…å«æ‰€æœ‰æŒ‡æ¨™çš„ç¶œåˆåœ–
- **loss_curve.png**: è¨“ç·´å’Œé©—è­‰ Loss æ›²ç·š
- **accuracy_curve.png**: Top-K æº–ç¢ºç‡æ›²ç·š
- **learning_curve.png**: å¹³æ»‘å¾Œçš„å­¸ç¿’æ›²ç·š
- **training_metrics.json**: JSON æ ¼å¼çš„å®Œæ•´æŒ‡æ¨™

### 3. Checkpoints (`output/checkpoints/`)

- æ¯ 10 å€‹ epoch è‡ªå‹•ä¿å­˜
- å¯ç”¨æ–¼åˆ†æè¨“ç·´éç¨‹
- åŒ…å«å®Œæ•´çš„æ¨¡å‹ç‹€æ…‹å’Œè¨“ç·´æ­·å²

## ğŸ” è¨“ç·´é‚è¼¯é©—è­‰

### ç¾æœ‰é‚è¼¯ï¼ˆå·²ç¢ºèªæ­£ç¢ºï¼‰ï¼š

1. âœ… **prepare_dataset.py** æŠ“å– 3000 éƒ¨ç†±é–€å‹•ç•«åŠ å…¥è³‡æ–™åº«
2. âœ… **load_users.py** å¾ `datas_user.txt` è®€å–ç”¨æˆ¶æ¸…å–®
3. âœ… **train_model.py** è¼‰å…¥æ•¸æ“šä¸¦é–‹å§‹è¨“ç·´

### æ•¸æ“šæµï¼š

```
AniList API
    â†“
prepare_dataset.py â†’ data/bert.db (3000 éƒ¨å‹•ç•«)
    â†“
load_users.py â†’ data/bert.db (ç”¨æˆ¶è§€çœ‹è¨˜éŒ„)
    â†“
train_model.py â†’ è®€å– bert.db
    â†“
è¨“ç·´ BERT4Rec æ¨¡å‹ (200 epochs)
    â†“
è¼¸å‡ºæ¨¡å‹ + åœ–è¡¨
```

## ğŸ“ˆ è¨“ç·´ç›£æ§

### å¯¦æ™‚ç›£æ§

è¨“ç·´éç¨‹ä¸­æœƒé¡¯ç¤ºï¼š

```
Epoch 1/200
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¨“ç·´ä¸­: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 45/45 [00:32<00:00]
  è¨“ç·´ Loss: 8.2341
  è¨“ç·´ Top-1 Acc: 0.0234
  è¨“ç·´ Top-5 Acc: 0.1123
  è¨“ç·´ Top-10 Acc: 0.1856

é©—è­‰ä¸­: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [00:02<00:00]
  é©—è­‰ Loss: 8.1234
  é©—è­‰ Top-1 Acc: 0.0289
  é©—è­‰ Top-5 Acc: 0.1267
  é©—è­‰ Top-10 Acc: 0.1943
  ğŸŒŸ æ–°çš„æœ€ä½³æ¨¡å‹ï¼
```

### æ—¥èªŒè¨˜éŒ„

æ‰€æœ‰è¨“ç·´ä¿¡æ¯éƒ½æœƒè¨˜éŒ„åˆ°ï¼š
- `training.log` - è©³ç´°çš„è¨“ç·´æ—¥èªŒ
- `prepare_bert_dataset.log` - æ•¸æ“šæº–å‚™æ—¥èªŒ
- `load_users.log` - ç”¨æˆ¶è¼‰å…¥æ—¥èªŒ

## ğŸ“ é æœŸæ•ˆæœ

### è‰¯å¥½çš„è¨“ç·´çµæœï¼š

- **Loss**: å¾ 8-10 é™åˆ° 3-5
- **Top-1 Accuracy**: 10-20%
- **Top-5 Accuracy**: 25-40%
- **Top-10 Accuracy**: 35-55%
- **Top-20 Accuracy**: 45-65%

### åœ–è¡¨ç‰¹å¾µï¼š

- Loss æ›²ç·šæ‡‰è©²æŒçºŒä¸‹é™ä¸¦è¶¨æ–¼å¹³ç©©
- Accuracy æ›²ç·šæ‡‰è©²æŒçºŒä¸Šå‡ä¸¦è¶¨æ–¼å¹³ç©©
- è¨“ç·´å’Œé©—è­‰æ›²ç·šä¸æ‡‰å·®è·éå¤§ï¼ˆé¿å…éæ“¬åˆï¼‰

## ğŸ› ï¸ è‡ªè¨‚èª¿æ•´

### å¿«é€Ÿæ¸¬è©¦ï¼ˆ10 epochsï¼‰

```bash
python train_model.py --epochs 10 --batch-size 32
```

### æ¨™æº–è¨“ç·´ï¼ˆ200 epochsï¼‰

```bash
python train_model.py --epochs 200 --batch-size 64 --gpu
```

### å¤§æ¨¡å‹è¨“ç·´ï¼ˆæ›´å¥½æ•ˆæœï¼‰

```bash
python train_model.py \
  --epochs 200 \
  --batch-size 128 \
  --hidden-size 512 \
  --num-layers 4 \
  --gpu
```

### è¨˜æ†¶é«”å„ªåŒ–ï¼ˆå° batchï¼‰

```bash
python train_model.py \
  --epochs 200 \
  --batch-size 32 \
  --max-seq-len 100
```

## ğŸ’¡ é‡è¦ç‰¹æ€§

### 1. æº–ç¢ºç‡è¨ˆç®—

çœŸå¯¦çš„ Top-K Accuracy è¨ˆç®—ï¼š
- æª¢æŸ¥é æ¸¬çš„å‰ K å€‹é …ç›®ä¸­æ˜¯å¦åŒ…å«æ­£ç¢ºç­”æ¡ˆ
- åªè¨ˆç®—é padding ä½ç½®
- æ”¯æŒ Top-1, 5, 10, 20

### 2. è¦–è¦ºåŒ–åŠŸèƒ½

- è‡ªå‹•ç”Ÿæˆå¤šç¨®åœ–è¡¨
- åŒ…å«æœ€å°å€¼æ¨™è¨»
- å¹³æ»‘æ›²ç·šè™•ç†
- é«˜æ¸… PNG è¼¸å‡º (300 DPI)

### 3. è‡ªå‹•å„²å­˜

- æœ€ä½³æ¨¡å‹è‡ªå‹•ä¿å­˜
- å®šæœŸ checkpointï¼ˆæ¯ 10 epochsï¼‰
- å®Œæ•´è¨“ç·´æ­·å²è¨˜éŒ„
- JSON æ ¼å¼æŒ‡æ¨™è¼¸å‡º

### 4. GPU æ”¯æ´

- è‡ªå‹•æª¢æ¸¬ GPU
- FP16 æ··åˆç²¾åº¦è¨“ç·´ï¼ˆå¯é¸ï¼‰
- æ‰¹æ¬¡å¤§å°è‡ªå‹•èª¿æ•´å»ºè­°

## ğŸ“š æ–‡æª”èªªæ˜

- **README.md**: å®Œæ•´çš„ä½¿ç”¨èªªæ˜ï¼ˆ318 è¡Œï¼‰
- **QUICK_START.md**: å¿«é€Ÿé–‹å§‹æŒ‡å—ï¼ˆ275 è¡Œï¼‰
- **SUMMARY.md**: æœ¬æ–‡ä»¶ï¼Œé …ç›®ç¸½çµ
- **ä»£ç¢¼è¨»è§£**: æ‰€æœ‰ä¸»è¦å‡½æ•¸éƒ½æœ‰è©³ç´°è¨»è§£

## âœ¨ èˆ‡åŸå§‹ç‰ˆæœ¬çš„æ”¹é€²

### æ–°å¢åŠŸèƒ½ï¼š

1. âœ… **Top-K Accuracy è¨ˆç®—**ï¼ˆåŸæœ¬åªæœ‰ Lossï¼‰
2. âœ… **å®Œæ•´çš„è¦–è¦ºåŒ–ç³»çµ±**ï¼ˆ4 ç¨®åœ–è¡¨ + JSONï¼‰
3. âœ… **é…ç½®ç®¡ç†ç³»çµ±**ï¼ˆé›†ä¸­åŒ–é…ç½®ï¼‰
4. âœ… **æ‰¹æ¬¡åŸ·è¡Œè…³æœ¬**ï¼ˆ6 å€‹ .bat æ–‡ä»¶ï¼‰
5. âœ… **å®Œæ•´çš„æ–‡æª”**ï¼ˆ3 å€‹ markdown æ–‡ä»¶ï¼‰
6. âœ… **ç›®éŒ„çµæ§‹å„ªåŒ–**ï¼ˆdata/ å’Œ output/ åˆ†é›¢ï¼‰

### æ”¹é€²ï¼š

1. âœ… **Epochs æ”¹ç‚º 200**ï¼ˆåŸæœ¬ 30ï¼‰
2. âœ… **æ›´å¥½çš„é€²åº¦é¡¯ç¤º**ï¼ˆtqdm + postfixï¼‰
3. âœ… **è‡ªå‹•ç’°å¢ƒæª¢æŸ¥**ï¼ˆsetup.batï¼‰
4. âœ… **å®Œæ•´çš„éŒ¯èª¤è™•ç†**
5. âœ… **æ›´è©³ç´°çš„æ—¥èªŒè¨˜éŒ„**

## ğŸ”— ä¾è³´å¥—ä»¶

```
torch>=2.0.0              # æ·±åº¦å­¸ç¿’æ¡†æ¶
numpy>=1.24.0             # æ•¸å€¼è¨ˆç®—
matplotlib>=3.7.0         # è¦–è¦ºåŒ–
sqlmodel>=0.0.14          # è³‡æ–™åº« ORM
aiohttp>=3.9.0            # ç•°æ­¥ HTTP
tqdm>=4.66.0              # é€²åº¦æ¢
```

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè­°

1. **é‹è¡Œæ¸¬è©¦è¨“ç·´**ï¼ˆ10 epochsï¼‰é©—è­‰ç’°å¢ƒ
2. **æ­£å¼è¨“ç·´**ï¼ˆ200 epochsï¼‰ç²å¾—æœ€ä½³æ¨¡å‹
3. **åˆ†æçµæœ**æŸ¥çœ‹è¨“ç·´åœ–è¡¨
4. **æ•´åˆåˆ°æ¨è–¦ç³»çµ±**ä½¿ç”¨è¨“ç·´å¥½çš„æ¨¡å‹

## ğŸ‰ ç¸½çµ

é€™æ˜¯ä¸€å€‹**å®Œæ•´ã€çœŸå¯¦ã€å¯ç”¨**çš„ BERT4Rec è¨“ç·´æ¶æ§‹ï¼š

- âœ… çœŸå¯¦çš„æ•¸æ“šï¼ˆå¾ AniList æŠ“å–ï¼‰
- âœ… å®Œæ•´çš„è¨“ç·´æµç¨‹ï¼ˆæ•¸æ“š â†’ è¨“ç·´ â†’ è©•ä¼°ï¼‰
- âœ… æº–ç¢ºçš„æŒ‡æ¨™è¨ˆç®—ï¼ˆLoss + Top-K Accuracyï¼‰
- âœ… è±å¯Œçš„è¦–è¦ºåŒ–ï¼ˆ4 ç¨®åœ–è¡¨ï¼‰
- âœ… ä¾¿æ·çš„åŸ·è¡Œæ–¹å¼ï¼ˆä¸€éµæˆ–åˆ†æ­¥ï¼‰
- âœ… è©³ç´°çš„æ–‡æª”ï¼ˆ3 å€‹ markdownï¼‰
- âœ… 200 epochs è¨“ç·´é…ç½®

**ç«‹å³é–‹å§‹**: åŸ·è¡Œ `setup.bat` ç„¶å¾Œ `run_all.bat`ï¼

---

**å‰µå»ºæ—¥æœŸ**: 2024
**ç‰ˆæœ¬**: 1.0
**ç‹€æ…‹**: å®Œæˆ âœ…