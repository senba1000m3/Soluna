# BERT4Rec å‹•ç•«æ¨è–¦æ¨¡å‹è¨“ç·´

å®Œæ•´çš„ BERT4Rec æ¨¡å‹è¨“ç·´æ¶æ§‹ï¼ŒåŒ…å«æ•¸æ“šæº–å‚™ã€æ¨¡å‹è¨“ç·´ã€è¦–è¦ºåŒ–ç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®éŒ„çµæ§‹

```
bert_training/
â”œâ”€â”€ config.py              # è¨“ç·´é…ç½®
â”œâ”€â”€ train_model.py         # ä¸»è¨“ç·´è…³æœ¬
â”œâ”€â”€ visualize.py           # è¦–è¦ºåŒ–å·¥å…·
â”œâ”€â”€ prepare_dataset.py     # æº–å‚™å‹•ç•«æ•¸æ“š
â”œâ”€â”€ load_users.py          # è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
â”œâ”€â”€ anilist_client.py      # AniList API å®¢æˆ¶ç«¯
â”œâ”€â”€ datas_user.txt         # ç”¨æˆ¶åå–®
â”œâ”€â”€ requirements.txt       # ä¾è³´å¥—ä»¶
â”œâ”€â”€ README.md              # æœ¬æ–‡ä»¶
â”œâ”€â”€ data/                  # è³‡æ–™ç›®éŒ„
â”‚   â””â”€â”€ bert.db           # è¨“ç·´æ•¸æ“šåº«
â””â”€â”€ output/               # è¼¸å‡ºç›®éŒ„
    â”œâ”€â”€ models/           # è¨“ç·´å¥½çš„æ¨¡å‹
    â”œâ”€â”€ plots/            # è¨“ç·´åœ–è¡¨
    â”œâ”€â”€ logs/             # è¨“ç·´æ—¥èªŒ
    â””â”€â”€ checkpoints/      # è¨“ç·´ checkpoint
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´

```bash
pip install -r requirements.txt
```

### 2. æº–å‚™æ•¸æ“š

#### æ­¥é©Ÿ 1ï¼šæŠ“å–ç†±é–€å‹•ç•«ï¼ˆ3000 éƒ¨ï¼‰

```bash
python prepare_dataset.py --count 3000
```

é€™æœƒï¼š
- å¾ AniList æŠ“å– 3000 éƒ¨æœ€ç†±é–€çš„å‹•ç•«
- å„²å­˜åˆ° `data/bert.db` è³‡æ–™åº«
- å»ºç«‹å‹•ç•«è³‡æ–™è¡¨

#### æ­¥é©Ÿ 2ï¼šè¼‰å…¥ç”¨æˆ¶è§€çœ‹æ¸…å–®

```bash
python load_users.py
```

æˆ–æŒ‡å®šè‡ªè¨‚ç”¨æˆ¶æ–‡ä»¶ï¼š

```bash
python load_users.py --file custom_users.txt --min-anime 50
```

é€™æœƒï¼š
- å¾ `datas_user.txt` è®€å–ç”¨æˆ¶åå–®
- æŠ“å–æ¯å€‹ç”¨æˆ¶çš„å‹•ç•«è§€çœ‹è¨˜éŒ„
- å„²å­˜åˆ°è³‡æ–™åº«ä¾›è¨“ç·´ä½¿ç”¨

### 3. è¨“ç·´æ¨¡å‹

#### åŸºæœ¬è¨“ç·´ï¼ˆ200 epochsï¼‰

```bash
python train_model.py
```

#### ä½¿ç”¨ GPU åŠ é€Ÿ

```bash
python train_model.py --gpu
```

#### è‡ªè¨‚åƒæ•¸è¨“ç·´

```bash
python train_model.py \
  --epochs 200 \
  --batch-size 128 \
  --lr 0.001 \
  --hidden-size 256 \
  --num-layers 2 \
  --gpu
```

## ğŸ“Š è¨“ç·´è¼¸å‡º

è¨“ç·´å®Œæˆå¾Œï¼Œæœƒè‡ªå‹•ç”Ÿæˆä»¥ä¸‹å…§å®¹ï¼š

### 1. æ¨¡å‹æ–‡ä»¶ï¼ˆ`output/models/`ï¼‰
- `best_model.pth` - é©—è­‰ Loss æœ€ä½çš„æ¨¡å‹
- `final_model.pth` - æœ€å¾Œä¸€å€‹ epoch çš„æ¨¡å‹
- `item_mappings.pkl` - å‹•ç•« ID æ˜ å°„
- `training_config.json` - è¨“ç·´é…ç½®

### 2. è¦–è¦ºåŒ–åœ–è¡¨ï¼ˆ`output/plots/`ï¼‰
- `loss_curve.png` - Loss æ›²ç·šåœ–
- `accuracy_curve.png` - Top-K Accuracy æ›²ç·šåœ–
- `combined_metrics.png` - ç¶œåˆæŒ‡æ¨™åœ–
- `learning_curve.png` - å¹³æ»‘å­¸ç¿’æ›²ç·š
- `training_metrics.json` - å®Œæ•´è¨“ç·´æŒ‡æ¨™

### 3. Checkpointsï¼ˆ`output/checkpoints/`ï¼‰
- æ¯ 10 å€‹ epoch è‡ªå‹•å„²å­˜ä¸€æ¬¡

## ğŸ¯ è¨“ç·´æŒ‡æ¨™

æ¨¡å‹æœƒè¨ˆç®—ä»¥ä¸‹æŒ‡æ¨™ï¼š

- **Loss**: CrossEntropyLossï¼ˆå¿½ç•¥ paddingï¼‰
- **Top-1 Accuracy**: é æ¸¬çš„ç¬¬ 1 åæ˜¯å¦æ­£ç¢º
- **Top-5 Accuracy**: é æ¸¬çš„å‰ 5 åä¸­æ˜¯å¦åŒ…å«æ­£ç¢ºç­”æ¡ˆ
- **Top-10 Accuracy**: é æ¸¬çš„å‰ 10 åä¸­æ˜¯å¦åŒ…å«æ­£ç¢ºç­”æ¡ˆ
- **Top-20 Accuracy**: é æ¸¬çš„å‰ 20 åä¸­æ˜¯å¦åŒ…å«æ­£ç¢ºç­”æ¡ˆ

## âš™ï¸ é…ç½®èªªæ˜

### è¨“ç·´åƒæ•¸ï¼ˆconfig.pyï¼‰

```python
epochs: 200              # è¨“ç·´è¼ªæ•¸
batch_size: 64          # æ‰¹æ¬¡å¤§å°
learning_rate: 1e-3     # å­¸ç¿’ç‡
val_ratio: 0.1          # é©—è­‰é›†æ¯”ä¾‹
```

### æ¨¡å‹åƒæ•¸

```python
hidden_size: 256        # éš±è—å±¤ç¶­åº¦
num_layers: 2          # Transformer å±¤æ•¸
num_heads: 4           # æ³¨æ„åŠ›é ­æ•¸
max_seq_len: 200       # æœ€å¤§åºåˆ—é•·åº¦
dropout: 0.1           # Dropout æ¯”ç‡
```

### ç¡¬é«”è¨­å®š

```python
use_gpu: True          # ä½¿ç”¨ GPU
use_fp16: False        # ä½¿ç”¨æ··åˆç²¾åº¦è¨“ç·´ï¼ˆéœ€è¦ GPUï¼‰
num_workers: 0         # DataLoader å·¥ä½œé€²ç¨‹æ•¸
```

## ğŸ“ å‘½ä»¤åˆ—åƒæ•¸

### prepare_dataset.py

```bash
python prepare_dataset.py [é¸é …]

é¸é …:
  --count N           æŠ“å– N éƒ¨ç†±é–€å‹•ç•« (é è¨­: 3000)
  --sort SORT         æ’åºæ–¹å¼ (é è¨­: POPULARITY_DESC)
```

### load_users.py

```bash
python load_users.py [é¸é …]

é¸é …:
  --file FILE         ç”¨æˆ¶åå–®æ–‡ä»¶ (é è¨­: datas_user.txt)
  --min-anime N       ç”¨æˆ¶æœ€å°‘å‹•ç•«æ•¸ (é è¨­: 20)
```

### train_model.py

```bash
python train_model.py [é¸é …]

è¨“ç·´åƒæ•¸:
  --epochs N          è¨“ç·´è¼ªæ•¸ (é è¨­: 200)
  --batch-size N      æ‰¹æ¬¡å¤§å° (é è¨­: 64)
  --lr FLOAT          å­¸ç¿’ç‡ (é è¨­: 0.001)
  --val-ratio FLOAT   é©—è­‰é›†æ¯”ä¾‹ (é è¨­: 0.1)

æ¨¡å‹åƒæ•¸:
  --hidden-size N     éš±è—å±¤å¤§å° (é è¨­: 256)
  --num-layers N      Transformer å±¤æ•¸ (é è¨­: 2)
  --num-heads N       æ³¨æ„åŠ›é ­æ•¸ (é è¨­: 4)
  --max-seq-len N     æœ€å¤§åºåˆ—é•·åº¦ (é è¨­: 200)
  --dropout FLOAT     Dropout (é è¨­: 0.1)

ç¡¬é«”è¨­å®š:
  --gpu               ä½¿ç”¨ GPU
  --fp16              ä½¿ç”¨ FP16 æ··åˆç²¾åº¦è¨“ç·´
  
å…¶ä»–:
  --seed N            éš¨æ©Ÿç¨®å­ (é è¨­: 42)
```

## ğŸ” è¨“ç·´æµç¨‹è©³è§£

### 1. æ•¸æ“šæº–å‚™éšæ®µ

1. **æŠ“å–ç†±é–€å‹•ç•«**: å¾ AniList ç²å– 3000 éƒ¨æœ€å—æ­¡è¿çš„å‹•ç•«
2. **å»ºç«‹æ˜ å°„**: å‰µå»º anime_id åˆ°ç´¢å¼•çš„æ˜ å°„
3. **è¼‰å…¥ç”¨æˆ¶**: æŠ“å–ç”¨æˆ¶çš„è§€çœ‹è¨˜éŒ„
4. **éæ¿¾æ•¸æ“š**: åªä¿ç•™æœ‰è¶³å¤ è§€çœ‹è¨˜éŒ„çš„ç”¨æˆ¶ï¼ˆé è¨­ â‰¥20 éƒ¨ï¼‰

### 2. è¨“ç·´éšæ®µ

1. **æ•¸æ“šåˆ†å‰²**: æŒ‰ç…§ 9:1 åˆ†å‰²è¨“ç·´é›†å’Œé©—è­‰é›†
2. **åºåˆ—è™•ç†**: 
   - å°‡ç”¨æˆ¶è§€çœ‹è¨˜éŒ„è½‰æ›ç‚ºåºåˆ—
   - éš¨æ©Ÿé®ç½© 15% çš„é …ç›®ï¼ˆBERT é¢¨æ ¼ï¼‰
   - å¡«å……/æˆªæ–·åˆ°å›ºå®šé•·åº¦
3. **æ¨¡å‹è¨“ç·´**:
   - ä½¿ç”¨ Transformer Encoder
   - é æ¸¬è¢«é®ç½©çš„é …ç›®
   - è¨ˆç®— Loss å’Œ Top-K Accuracy
4. **å®šæœŸå„²å­˜**: æ¯ 10 å€‹ epoch å„²å­˜ä¸€æ¬¡ checkpoint

### 3. è©•ä¼°éšæ®µ

- æ¯å€‹ epoch çµæŸå¾Œé€²è¡Œé©—è­‰
- è¨˜éŒ„ Loss å’Œ Top-K Accuracy
- è‡ªå‹•å„²å­˜æœ€ä½³æ¨¡å‹

### 4. è¦–è¦ºåŒ–éšæ®µ

- è¨“ç·´å®Œæˆå¾Œè‡ªå‹•ç”Ÿæˆæ‰€æœ‰åœ–è¡¨
- å„²å­˜å®Œæ•´çš„è¨“ç·´æŒ‡æ¨™ç‚º JSON

## ğŸ“ˆ æŸ¥çœ‹è¨“ç·´çµæœ

### æŸ¥çœ‹åœ–è¡¨

è¨“ç·´å®Œæˆå¾Œï¼Œæª¢æŸ¥ `output/plots/` ç›®éŒ„ï¼š

```bash
# Windows
start output/plots/combined_metrics.png

# Linux/Mac
xdg-open output/plots/combined_metrics.png
```

### æŸ¥çœ‹è¨“ç·´æŒ‡æ¨™

```bash
cat output/plots/training_metrics.json
```

### æŸ¥çœ‹æ—¥èªŒ

```bash
cat training.log
```

## ğŸ› ï¸ å¸¸è¦‹å•é¡Œ

### Q: è³‡æ–™åº«ç‚ºç©ºæ€éº¼è¾¦ï¼Ÿ

A: è«‹ç¢ºä¿æŒ‰é †åºåŸ·è¡Œï¼š
1. å…ˆåŸ·è¡Œ `prepare_dataset.py`
2. å†åŸ·è¡Œ `load_users.py`
3. æœ€å¾ŒåŸ·è¡Œ `train_model.py`

### Q: GPU è¨˜æ†¶é«”ä¸è¶³ï¼Ÿ

A: å˜—è©¦ä»¥ä¸‹æ–¹æ³•ï¼š
- æ¸›å°‘ `batch_size`: `--batch-size 32`
- æ¸›å°‘ `hidden_size`: `--hidden-size 128`
- æ¸›å°‘ `max_seq_len`: `--max-seq-len 100`

### Q: è¨“ç·´å¤ªæ…¢ï¼Ÿ

A: å„ªåŒ–å»ºè­°ï¼š
- ä½¿ç”¨ GPU: `--gpu`
- å•Ÿç”¨ FP16ï¼ˆéœ€è¦ GPUï¼‰: `--fp16`
- å¢åŠ  `batch_size` (å¦‚æœè¨˜æ†¶é«”å…è¨±)

### Q: æº–ç¢ºç‡å¤ªä½ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
- æ•¸æ“šé‡ä¸è¶³ï¼šå¢åŠ æ›´å¤šç”¨æˆ¶
- è¨“ç·´ä¸è¶³ï¼šå¢åŠ  epochs
- æ¨¡å‹å¤ªå°ï¼šå¢åŠ  `hidden_size` æˆ– `num_layers`
- å­¸ç¿’ç‡ä¸ç•¶ï¼šèª¿æ•´ `--lr`

### Q: å¦‚ä½•ç¹¼çºŒè¨“ç·´ï¼Ÿ

A: ç›®å‰ä¸æ”¯æŒå¾ checkpoint ç¹¼çºŒè¨“ç·´ï¼Œä½†å¯ä»¥ä¿®æ”¹ä»£ç¢¼åŠ å…¥æ­¤åŠŸèƒ½ã€‚

## ğŸ“Š é æœŸæ•ˆæœ

æ ¹æ“šæ•¸æ“šè³ªé‡å’Œæ•¸é‡ï¼Œé æœŸçš„è¨“ç·´çµæœï¼š

- **Top-1 Accuracy**: 10-20%
- **Top-5 Accuracy**: 25-40%
- **Top-10 Accuracy**: 35-55%
- **Top-20 Accuracy**: 45-65%

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [BERT4Rec è«–æ–‡](https://arxiv.org/abs/1904.06690)
- [AniList API æ–‡æª”](https://anilist.gitbook.io/anilist-apiv2-docs/)
- [PyTorch æ–‡æª”](https://pytorch.org/docs/stable/index.html)

## ğŸ“„ æˆæ¬Š

æ­¤å°ˆæ¡ˆç‚º Soluna æ¨è–¦ç³»çµ±çš„ä¸€éƒ¨åˆ†ã€‚

## ğŸ‘¥ è²¢ç»

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚

---

**æœ€å¾Œæ›´æ–°**: 2024
**ç‰ˆæœ¬**: 1.0